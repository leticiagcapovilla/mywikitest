# CON: NTP

##  Introduction 

The NTP protocol implements many solutions that allow to synchronize the clocks of the hosts belonging to a computer network. The protocol uses various metrics, described in next sections, in order to determine which are the most accurate and consistent sources to request synchronization from. In addition to those statistics, NTP makes use of selection, clustering and combination algorithms to determine, in turn, which of the previous selected servers are the most reliable ones.

UDP packets are used by the protocol to exchange messages between the servers and clients, supporting both IPv4 and IPv6 versions. Despite the fact that the UDP protocol cannot ensure that a message was in fact received by the target and does not offer any mechanisms of error correction, NTPv4 implements some tools, such as the On-Wire protocol, capable of verifying the data consistency of received packets to proceed correctly in case of packet losses of duplicates.

Considering that the Sirius' controls system will be composed of a big amount of connected [[CON:Sirius_control_system_SBCs|BeagleBones Blacks]](link) and hosts, it is of high importance that both date and time of all these hosts are correctly synchronized among each other, in order to ensure coherence between the logs and the variable timestamps generated by the EPICS library. A NTP server is capable of supplying synchronism to a variable number of clients, provided that these clients are configured to do to so.

Many institutes provide, across the Internet, reference clocks (or stratum 1 servers), generated by special equipaments such GPS receivers, atomic clocks or other radio clocks. For the Sirius' controls network, which it's intended to be completely isolated from external networks, obtaining the time synchronization from the Internet cannot be considered. Therefore, we propose in this document the implementation of a stratum 1 NTP server, being composed of a GPS receiver attached to a dedicated BeagleBone Black hosting the server.

GPS receivers are able to provide timing information, such as date and time in the UTC standard, and a pulse (1PPS) with frequency of 1Hz and accuracy on the order of 50ns. One can imagine that only the time provided is sufficient for the implementation of an NTP server server. However, delays with which information is received and is transmitted by the receiver are not constant and vary according to some parameters such as temperature and signal quality. Therefore, in order to provide a precise synchronized time, the NTP server must use the 1PPS pulse, whose main purpose is to mark the start of a new second. The combination of this pulse, the provided date and time and an operating system whose kernel is enabled to treat such pulses, allows the implementation of a server capable of providing synchronization with microsecond accuracy. It is important to note that the PPS must be combined with some other time source, since it is not able to tell the effective timing, that is, hours, minutes and seconds, but only the beginning of a new second.

##  Hardware 

[[Image:gps-ublox.jpg|thumb|right|]]

|![](/img/groups/con/ntp/Gps-ublox.jpg)|
|-|
|**Figure 7**: SDeveloped board for [CAM-M8Q](https://www.u-blox.com/en/product/cam-m8-series){target=_blank}{target=_blank}.|

In total, we've used 4 different models of GPS receivers:

* Adafruit's [Ultimate GPS Breakout](https://www.adafruit.com/product/746){target=_blank}.
* MikroElektronika's [GPS Click](https://shop.mikroe.com/gps-click){target=_blank}.
* ublox's [CAM-M8Q](https://www.u-blox.com/en/product/cam-m8-series){target=_blank} (figure) and [EVK-M8F](https://www.u-blox.com/en/product/evk-8evk-m8){target=_blank}.

For the first three models, it was necessary to develop some integration boards to connect the receivers to input headers of the ''BeagleBone Black''. The board projects, developed from the [[CON:Setting_up_a_Linux_workstation#KiCad_suite|Kicad]](link) software, can be retrieved in the [gps-receiver-bb-capes](http://git.cnpem.br/gustavo.pinton/gps-receiver-bb-capes){target=_blank} repository (available only for internal access). The design of these boards is very simple:

* `RX` and `TX` are connected to the pins `P9.13` and `P9.11`, which can act either as UART input or UART output.
* The receivers' output pin `1PPS` is associated with a BeagleBone Black's general purpose pin. By the fact of being near of the pins chose for communication, `P9.12` pin is assigned to be connected to the 1PPS pulse.
* A monostable multivibrator, [74HC123](https://assets.nexperia.com/documents/data-sheet/74HC_HCT123.pdf){target=_blank}, was also used with the objective of widening the active part of the 1PPS pulse. Such feature should be adopted for older receiver models only, since the width of the active pulse for such devices could not be sufficiently big to be detected by the BeagleBone board. However, for the ones listed above, the use of this circuit is not required, because all of them provide pulses which remain active for more than 100ms. The control of which PPS signal (from the receiver or multivibrator) will be used by the NTP server is done by jumper present on the board.

The [EVK-M8F](https://www.u-blox.com/en/product/evk-8evk-m8){target=_blank} module, because its consist of an evaluation kit, does not need any integration boards to communicate with the ''BeagleBone Black''. In this case, the receiver's PPS output is connected directly to the `P9.12` pin as in the previous cases, but the serial communication is performed via USB.

##  Setting up 

[ntp-gps-building-scripts](http://git.cnpem.br/gustavo.pinton/ntp-gps-building-scrips){target=_blank} repository contains all the required scripts to install and set all system components up. The following components are used:

* `dts`: defines the function of the `P9.11`, `P9.12` and `P9.13` pins. Executing  `dts/setup-dts.sh` compiles the `.dts` source file and copies the binary result to the `/lib/firmware` folder. The `--tty` and `--setup` options allow, respectively, that any other `/dev/tty*` device is adopted and to update the `dtc` compiler before compiling the source files.

* `pps`: downloads and installs the tools to test the acquisition of the PPS pulse.

* `gpsd`: downloads, installs and sets up the application which performs the communication with the GPS receiver. Check the script's available options with the command

<pre>
$ ./gpsd/setup-gpsd.sh --help
</pre>

* `ntpd`: retrieves the data produced by the `gpsd` and the PPS pulses detection time instants to adjust the BeagleBone's internal clock. Besides, it sends the date/time for other hosts which are set up to synchronize their clock with this server. The `ntpd/setup-ntpd.sh` script, like the previous ones, assists in the setup and installation processes, which include the daemon compilation from its source code. This should be performed by the fact that the driver which processes the PPS acquisition, called `atom-driver`, needs to be included in the binary. Such driver, by default, is not included in the versions available in the official repositories of the Debian release, in opposition with the ones present in the Ubunut repositories. Besides, this script also enables ''ntpdate.service'' systemd service, responsible to adjust the Beagle's clock as soon as it boots.

* `[streamdevice](https://github.com/lnls-sirius/stream-ioc){target=_blank}`: application which provides the EPICS variables to the network by communicating with the `ioc` program. To install it, execute `ntpd/setup-streamdevice.sh`.

* `ioc`: program which communicates with the `ntpd` and `gpsd` daemons to retrieve important parameters from them, such as offset, jitter, time etc. The information obtained from this program is transmitted to a [stream-ioc](https://github.com/lnls-sirius/stream-ioc){target=_blank} instance via a unix socket. The compilation process of this program is performed by the `ioc/setup-ioc.sh` script and its source code can be found in [ntpd-gpsd-epics](http://git.cnpem.br/gustavo.pinton/ntp-gps-epics-server-and-opi-interfaces){target=_blank}, as well as the `*.db` and `*.proto` files used by the streamdevice instance.

It's important to emphasize that all default values used by the above scripts are defined in `global-env.sh`. The scripts execution order must follow the same order in which they were enumerated.

###  Debugging ###  

To test whether the ''BeagleBone Black'' board is communicating with the GPS receiver correctly, execute:

<pre>
$ gpsmon
</pre>

If you see commands being exchanged between the two devices, then the `gpsd` was set up correctly. Otherwise, verify if `/dev/tty*` exists and, in the negative case, the `overlay_GPS-00A0.dtbo` file probably was not loaded correctly. If it exists and the communication is still unsuccesfull, check the hardware again.

The last aspect to be tested is the PPS acquisition:

<pre>
$ ppstest /dev/pps0
</pre>

If the output of this command resembles with the following lines, with a 1-second interval between the generation of two successive lines, then the acquisition is good. Otherwise, as the previous case, check if `/dev/pps0` exists and if the `overlay_GPS-00A0.dtbo` overlay was loaded correctly by the system. If these two aspects are OK, then check the hardware.

<pre>
source 0 - assert 1500493047.000001487, sequence: 3130743 - clear  0.000000000, sequence: 0
source 0 - assert 1500493047.999999255, sequence: 3130744 - clear  0.000000000, sequence: 0
</pre>

To test the `ntpd` daemon, execute 

<pre>
$ ntpq -p
</pre>

The output must have at last 3 lines, as below:

<pre>
     remote           refid      st t when poll reach   delay   offset  jitter
###### ###### ###### ###### ###### ###### ###### ###### ###### ###### ###### #
 LOCAL(0)        .LOCL.          10 l  26d   64    0    0.000    0.000   0.000
*SHM(0)          .GPS.            0 l    6    8  377    0.000  -108.32  17.369
oPPS(0)          .PPS.            0 l    4    8  377    0.000    0.001   0.002
</pre>

Character `o` indicates that the internal clock is being adjusted with reference to the PPS pulse. If any of the lines does not show up, there is a big probability that one of the `systemd` services have not initiliazed correctly. In this case, there is no secret: it is necessary to set up one by one using the command

<pre>
systemctl status <service>
</pre>

in which `service` could be `gpsd.service`, `ntpd.service` or `ntpdate.service`. Do the same to debug the `ioc` (`ioc.service`) and the `streamdevice` (`stream-ioc.service`).

##  Available NTP servers 

Three servers are currently in use and can be accessed from the addresses `10.128.1.239` (accessible from controls group internal network only), `10.0.6.41` and `10.0.6.48` (acessible from any computer in CNPEM's campus). To append them to the servers list consulted for synchronization, you only need to add the following line to the `/etc/ntp.conf` file:

<pre>
server <ip_address> iburst minpoll 3 maxpoll 3
</pre>

in which `<ip_address>` is only of the IP addresses described above. Next, restart the `ntp` service with:

<pre>
systemctl restart ntp.service
</pre>

##  Pre-built Debian image ##  

A pre-built image composed of ''Debian'' 7.11 and ''kernel'' 4.9.30-bone4 is available for download from [this link](http://10.0.4.57/lnls-beagle-images/BBB_GPS.img){target=_blank} (accessible only from CNPEM campus). To install it, load it into a microSD card with your preferred program (such as the `gnome-disks` utility) and next insert the card into the appropriate slot of a powered off ''BeagleBone Black''. Turn it on and wait the image to be completely copied into the eMMC memory. At the end of the process, the board will shut down and the card can be be removed.
